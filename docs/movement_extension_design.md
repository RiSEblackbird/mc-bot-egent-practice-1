# 移動系拡張ポイントと強制移動リトライ設計ガイド

本ドキュメントは Mineflayer ボットの移動系コンポーネントを拡張する際の指針と、`forcedMove` リトライの設計方針、さらにモジュール分割の基本方針をまとめたものです。新規メンバーが安全に変更を加えられるよう、参照元とテスト観点を明示しています。

## 1. 移動系機能の拡張ポイント

- **設定集約レイヤー**: `node-bot/runtime/config.ts` と `node-bot/runtime/env.ts` は、移動関連の環境変数（`PATHFINDER_ALLOW_PARKOUR` や `MOVE_GOAL_TOLERANCE` など）を正規化する唯一の入口です。新しいトグルや閾値を導入する際はここに追加し、型定義とバリデーションをセットで行います。
- **経路探索の戦略差し替え**: Mineflayer の pathfinder へ渡すオプションは `MovementResolution` 経由で注入されます。`resolveMovementConfig` を拡張し、パラメータ変換を 1 箇所にまとめることで、ボット本体から探索戦略を疎結合に保ちます。
- **行動ディスパッチ層**: `node-bot/bot.ts` の移動関連メソッドは、受け取った座標や経路設定をそのまま mineflayer へ委譲する薄いラッパーにとどめます。新規の移動コマンドを追加する場合も、バリデーションとロギングをラッパーで完結させ、mineflayer への依存はサービス層に閉じ込めてください。
- **Python 側の計画生成**: `python/planner/graph.py` と `python/runtime/action_graph.py` では、移動ステップの生成と executor 選択（mineflayer / minedojo / chat）を分離しています。移動カテゴリを増やす場合は DSL の `ActionDirective` 拡張と合わせてグラフノードを調整し、Mineflayer に渡す前段で責務が分割されていることを確認してください。
- **移動カテゴリの正規化**: `move_to_player` のような派生カテゴリも `runtime/rules.py` の `ACTION_TASK_RULES` に登録し、`route_module` で `move` モジュールへ正規化してから `handle_move` に渡します。未登録のカテゴリは backlog に落ちるため、追加時は必ずルールとルーティングをセットで更新してください。
- **追従先の決定**: `move_to_player` はチャット送信者（`last_requester`）を追従対象として解決し、取得できない場合は障壁として報告して自己座標への誤移動を防ぎます。

## 2. `forcedMove` リトライ設計

`forcedMove` は、経路が途切れた場合でも一定回数の再試行で前進を試みるフェイルオーバー機構です。安易なリトライが無限ループや落下事故を招かないよう、以下のガイドラインを必ず守ってください。

1. **環境変数で閾値を統一管理**: `FORCED_MOVE_RETRY_WINDOW_MS`（リトライ計測窓）、`FORCED_MOVE_MAX_RETRIES`（窓内の許容回数）、`FORCED_MOVE_RETRY_DELAY_MS`（次回試行までの待機）を `resolveMovementConfig` に集約し、`.env` から変更できるようにします。コード中にマジックナンバーを残さないでください。
2. **失敗イベントの記録**: リトライ発火時は構造化ログに `event=forced_move.retry`、座標・目的地・残リトライ回数を含めて出力します。最終的に諦めた場合は `event=forced_move.abort` を発行し、Python 側へも WebSocket 経由で通知して再計画を促します。
3. **短絡的な解除条件**: 落下・ダメージ・液体検知など危険度が高いイベントが発生した場合は、残リトライがあっても即座に強制移動を中断し、通常の pathfinder ルート再計算に戻します。安全性を最優先に設計してください。
4. **バックオフ戦略の検証**: リトライ遅延を増やした場合に移動レスポンスが極端に遅くならないか、`MOVE_GOAL_TOLERANCE` の緩和と併せて検証します。`node-bot/tests` にユニットテストを追加し、設定値ごとの分岐を網羅してください。

## 3. モジュール分割方針

- **単一責務の厳守**: 移動ロジックは「入力の正規化」「戦略決定」「実行」「テレメトリ」の 4 層に分け、役割をまたいだメソッドを持たせないようにします。条件分岐が増えた場合は、戦略オブジェクトやポリシークラスへ切り出してください。
- **拡張ポイントの明示**: 設定値やメトリクス名をハードコードせず、`runtime/env.ts`・`runtime/telemetryRuntime.ts` のような共通モジュールにまとめます。新しいメトリクスを追加する場合は、計測トリガーを 1 箇所に寄せ、他レイヤーからの直接参照を禁止します。
- **テスト容易性の確保**: 依存注入を活用し、Mineflayer への直接アクセスをモックで差し替えられる構造に保ちます。移動戦略クラスはインターフェースで抽象化し、ユニットテストで異常系（障害物、液体、リトライ上限超過）を明示的にカバーしてください。

## 4. メンテナンス手順

1. **設定追加時**: `runtime/env.ts` と `runtime/config.ts` に型定義・バリデーション・デフォルト値を追記し、`.env.example` にも項目を追加します。変更後は `npm test`（node-bot 配下）を実行して回帰を確認します。
2. **移動戦略変更時**: 影響範囲を README と本ドキュメントへ反映し、リトライ挙動や安全マージンが変わった箇所を明文化します。Mineflayer 挙動が変わる場合はログ例も更新してください。
3. **障害対応時**: 強制移動が原因で停止したケースを再現するテストを追加し、再発防止策（設定値のデフォルト変更やチェック追加）を本ドキュメントに追記します。対応後は Python 側の再計画フローに影響がないか手動確認してください。
4. **リファクタリング時**: モジュール分割でファイル構成が変わる場合は、本ドキュメントのパスや章立てを維持しつつ、移動系の入口と依存関係図を更新します。不要になった設定やメトリクスは削除理由をコメントとして残し、未使用の依存をクリアします。

本ガイドに沿って変更を進めることで、移動機能の安全性と可観測性を高めながら、拡張性を維持できます。迷った場合はテストとロギングを先に整備し、既存の設定モジュールに寄せる方針を優先してください。
