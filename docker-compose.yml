services:
  bridge:
    # Paper + AgentBridge + CoreProtect をまとめた開発用サーバー
    image: itzg/minecraft-server:java21
    working_dir: /data
    environment:
      EULA: "TRUE"
      TYPE: "PAPER"
      VERSION: ${MC_VERSION:-1.21.1}
      ONLINE_MODE: "FALSE"
      ENABLE_RCON: "false"
      MEMORY: ${BRIDGE_JVM_MEMORY:-2G}
      INIT_MEMORY: ${BRIDGE_JVM_INIT_MEMORY:-1G}
      JVM_OPTS: ${BRIDGE_JVM_OPTS:-}
    volumes:
      - ./bridge-data:/data
      - ./bridge-plugin/build/libs:/data/plugins:ro
      - ./bridge-plugin/libs/CoreProtect-22.0.jar:/data/plugins/CoreProtect-22.0.jar:ro
    ports:
      # 外部から Paper へ直接入る必要がある場合のみ 25565 を開ける。
      # - "25566:25565"  # ホスト側ポートをずらす例
      - "19071:19071"
    extra_hosts:
      - "host.docker.internal:host-gateway" # Paper 側からホストの追加リソースへアクセスする場合に利用
    restart: unless-stopped

  node-bot:
    # TypeScript ソースをウォッチしながら Mineflayer ボットを再起動する開発用サービス
    image: node:22
    # ↑ Mineflayer v4.33.0 以降が要求する Node.js 22 系をベースイメージで確保し、
    #    古い Node.js で互換バージョン（4.25.0 など）がインストールされることによる
    #    プロトコル解析失敗（PartialReadError）を防止する。
    working_dir: /app
    volumes:
      - ./:/app
    extra_hosts:
      - "host.docker.internal:host-gateway" # Windows/macOS/WSL 環境から Paper サーバーへ接続するための名前解決
    env_file:
      - .env
    environment:
      # Mineflayer が Paper と揃った既定バージョンで起動するよう docker-compose 側でもフォールバックを指定する。
      MC_VERSION: ${MC_VERSION:-1.21.1}
      WS_HOST: ${WS_HOST:-0.0.0.0}
      WS_PORT: ${WS_PORT:-8765}
      AGENT_WS_URL: ${AGENT_WS_URL:-ws://python-agent:${AGENT_WS_PORT:-9000}}
      OTEL_EXPORTER_OTLP_ENDPOINT: ${OTEL_EXPORTER_OTLP_ENDPOINT:-http://host.docker.internal:4318}
      OTEL_SERVICE_NAME: ${OTEL_SERVICE_NAME:-mc-node-bot}
      OTEL_RESOURCE_ENVIRONMENT: ${OTEL_RESOURCE_ENVIRONMENT:-development}
      OTEL_TRACES_SAMPLER_RATIO: ${OTEL_TRACES_SAMPLER_RATIO:-1.0}
    command:
      - bash
      - -lc
      - |
        cd node-bot \
        && npm install \
        && npm run dev
    ports:
      - "8765:8765"
    stdin_open: true
    tty: true
    depends_on:
      - bridge

  python-agent:
    # Python エージェントを watchfiles で自動再実行する開発用サービス
    image: python:3.11
    working_dir: /app
    volumes:
      - ./:/app
    extra_hosts:
      - "host.docker.internal:host-gateway" # Python 側が Paper と通信する可能性に備え、同様に名前解決を登録
    env_file:
      - .env
    environment:
      # Node 側が公開する WebSocket ポートを 1 箇所で可変化し、複数環境での疎通設定を単純化する。
      WS_URL: ${WS_URL:-ws://node-bot:${WS_PORT:-8765}}
      AGENT_WS_HOST: ${AGENT_WS_HOST:-0.0.0.0}
      AGENT_WS_PORT: ${AGENT_WS_PORT:-9000}
      WATCHFILES_FORCE_POLLING: "true"
      PYTHONPATH: ${PYTHONPATH:-/app:/app/python}
    command:
      - bash
      - -lc
      - |
        # watchfiles CLI ではコマンド全体を 1 引数として渡さないと Python が対話モードで起動してしまい、
        # エージェントがポートをリッスンしないため明示的にクォートする。プロジェクトルートのまま
        # python 配下を監視し、モジュール検索パスを /app に残して ModuleNotFound エラーを防ぐ。
        pip install --no-cache-dir -r requirements.txt && \
        watchfiles --filter python --ignore-paths .venv -- "python -m python"
    stdin_open: true
    tty: true
    depends_on:
      - bridge
