services:
  node-bot:
    # TypeScript ソースをウォッチしながら Mineflayer ボットを再起動する開発用サービス
    image: node:22
    # ↑ Mineflayer v4.33.0 以降が要求する Node.js 22 系をベースイメージで確保し、
    #    古い Node.js で互換バージョン（4.25.0 など）がインストールされることによる
    #    プロトコル解析失敗（PartialReadError）を防止する。
    working_dir: /app
    volumes:
      - ./:/app
    extra_hosts:
      - "host.docker.internal:host-gateway" # Windows/macOS/WSL 環境から Paper サーバーへ接続するための名前解決
    env_file:
      - .env
    command:
      - bash
      - -lc
      - |
        cd node-bot \
        && npm install \
        && npm run dev
    ports:
      - "8765:8765"
    stdin_open: true
    tty: true

  python-agent:
    # Python エージェントを watchfiles で自動再実行する開発用サービス
    image: python:3.11
    working_dir: /app
    volumes:
      - ./:/app
    extra_hosts:
      - "host.docker.internal:host-gateway" # Python 側が Paper と通信する可能性に備え、同様に名前解決を登録
    env_file:
      - .env
    command:
      - bash
      - -lc
      - |
        pip install --no-cache-dir -r requirements.txt \
        && cd python \
        && watchfiles --filter python --ignore-paths .venv -- python agent.py
    stdin_open: true
    tty: true
